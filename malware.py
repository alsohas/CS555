import warnings
import numpy as np
import pandas as pd
import pickle
import dill
import random
from sklearn.naive_bayes import MultinomialNB
from sklearn.cross_validation import cross_val_score
from sklearn.tree import DecisionTreeClassifier
# Donot modify the method signatures and return dtypes
# you can include additional functions of your choice


class MalwareDetectionModel:

    def __init__(self):
        self.dtypes = {
            'ProductName': 'category',
            'EngineVersion': 'category',
            'AppVersion': 'category',
            'AvSigVersion': 'category',
            'IsBeta': 'bool',
            'RtpStateBitfield': 'float64',
            'IsSxsPassiveMode': 'bool',
            'DefaultBrowsersIdentifier': 'float64',
            'AVProductStatesIdentifier': 'object',
            'AVProductsInstalled': 'int64',
            'AVProductsEnabled': 'int64',
            'HasTpm': 'bool',
            'CountryIdentifier': 'category',
            'CityIdentifier': 'category',
            'OrganizationIdentifier': 'category',
            'GeoNameIdentifier': 'category',
            'LocaleEnglishNameIdentifier': 'category',
            'Platform': 'category',
            'Processor': 'category',
            'OsVer': 'category',
            'OsBuild': 'category',
            'OsSuite': 'category',
            'OsPlatformSubRelease': 'category',
            'OsBuildLab': 'category',
            'SkuEdition': 'category',
            'IsProtected': 'bool',
            'AutoSampleOptIn': 'bool',
            'PuaMode': 'category',
            'SMode': 'bool',
            'IeVerIdentifier': 'category',
            'SmartScreen': 'category',
            'Firewall': 'bool',
            'UacLuaenable': 'category',
            'Census_MDC2FormFactor': 'category',
            'Census_DeviceFamily': 'category',
            'Census_OEMNameIdentifier': 'category',
            'Census_OEMModelIdentifier': 'category',
            'Census_ProcessorCoreCount': 'int64',
            'Census_ProcessorManufacturerIdentifier': 'category',
            'Census_ProcessorModelIdentifier': 'category',
            'Census_ProcessorClass': 'category',
            'Census_PrimaryDiskTotalCapacity': 'float64',
            'Census_PrimaryDiskTypeName': 'category',
            'Census_SystemVolumeTotalCapacity': 'float64',
            'Census_HasOpticalDiskDrive': 'bool',
            'Census_TotalPhysicalRAM': 'float64',
            'Census_ChassisTypeName': 'category',
            'Census_InternalPrimaryDiagonalDisplaySizeInInches': 'float64',
            'Census_InternalPrimaryDisplayResolutionHorizontal': 'float64',
            'Census_InternalPrimaryDisplayResolutionVertical': 'float64',
            'Census_PowerPlatformRoleName': 'category',
            'Census_InternalBatteryType': 'category',
            'Census_InternalBatteryNumberOfCharges': 'float64',
            'Census_OSVersion': 'category',
            'Census_OSArchitecture': 'category',
            'Census_OSBranch': 'category',
            'Census_OSBuildNumber': 'category',
            'Census_OSBuildRevision': 'category',
            'Census_OSEdition': 'category',
            'Census_OSSkuName': 'category',
            'Census_OSInstallTypeName': 'category',
            'Census_OSInstallLanguageIdentifier': 'category',
            'Census_OSUILocaleIdentifier': 'category',
            'Census_OSWUAutoUpdateOptionsName': 'category',
            'Census_IsPortableOperatingSystem': 'bool',
            'Census_GenuineStateName': 'category',
            'Census_ActivationChannel': 'category',
            'Census_IsFlightingInternal': 'bool',
            'Census_IsFlightsDisabled': 'bool',
            'Census_FlightRing': 'category',
            'Census_ThresholdOptIn': 'bool',
            'Census_FirmwareManufacturerIdentifier': 'category',
            'Census_FirmwareVersionIdentifier': 'category',
            'Census_IsSecureBootEnabled': 'bool',
            'Census_IsWIMBootEnabled': 'bool',
            'Census_IsVirtualDevice': 'bool',
            'Census_IsTouchEnabled': 'bool',
            'Census_IsPenCapable': 'bool',
            'Census_IsAlwaysOnAlwaysConnectedCapable': 'bool',
            'Wdft_IsGamer': 'bool',
            'Wdft_RegionIdentifier': 'category',
            'HasDetections': 'bool',
        }

        # read in csv into dataframe
        df = pd.read_csv('malware_train_clean.csv', low_memory=False)
        df = df.drop('MachineIdentifier', 1)

        # assign dtypes
        df = df.astype(self.dtypes)

        # shuffling data
        all_ids = np.arange(len(df))
        random.shuffle(all_ids)

        # mapping categorical data to ints
        cat_columns = df.select_dtypes(['category']).columns
        df[cat_columns] = df[cat_columns].apply(lambda column: column.cat.codes)

        # resetting index
        df = df.reset_index()

        # prediction column
        y_train = df['HasDetections']
        # feature columns
        x_train = df.drop('HasDetections', 1)

        # training
        clf = MultinomialNB()
        # clf = DecisionTreeClassifier(max_depth=20)
        clf.fit(x_train, y_train)
        scores = cross_val_score(clf, x_train, y_train, cv=10)
        print(scores.mean())


    # trains a model, you can access the malware_train.csv file for training your model

    def train(self):

        print('Train Model')

    # predicts the probablity of a machine affected by malware. The input test_data is a pandas dataframe.
    # This function must return the predicted probabilities for the test machines

    def predict_probablities(self, test_data):

        print('Predict malware')

        return predictions


# calls the train function and saves the model_file
# # donot modify the contents
# if __name__ == "__main__":
#     detectionModel = MalwareDetectionModel()
#     detectionModel.train()
#     filename = 'malwaremodel.pkl'
#     f = open(filename, 'wb')
#     dill.dump(detectionModel, f)
#     f.close()

dm = MalwareDetectionModel()
